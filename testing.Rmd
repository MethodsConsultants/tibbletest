---
title: "Testing"
author: "Michael Battaglia"
date: "7/6/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

example_dat <- tibbletest::example_dat

```

```{r}

df <- example_dat %>%
  drop_na(treat)
treatment <- "treat"
cont_vars <- c("sugar_factor", "age")

var_named <- cont_vars %>%
  set_names()

df <- df %>%
  mutate(obs_weights = 1)

df %>%
  summarise_at(
    .vars = var_named,
    .funs = list(
      "Mean" = ~weighted_mean(.x, obs_weights),
      "SD" = ~weighted_sd(.x, obs_weights)
    )
  ) %>%
  gather(
    key = "Variable",
    value = "val"
  ) %>%
  separate(
    col = Variable,
    into = c("Variable", "mean_sd"),
    sep = "_(?!.*_)"
  ) %>%
  spread(
    key = mean_sd,
    value = val
  ) %>%
  mutate(Statistics = paste0(round(Mean, 2), " (", round(SD, 2), ")")) %>%
  select(-Mean, -SD)


df %>%
  summarise_at(
    .vars = var_named,
    .funs = list(
      "Mean" = ~weighted_mean(.x, obs_weights),
      "SD" = ~weighted_sd(.x, obs_weights)
    )
  ) %>%
  gather(
    key = "Variable",
    value = "val"
  ) %>%
  separate(
    col = Variable,
    into = c("Variable", "mean_sd"),
    sep = "_(?!.*_)"
  ) %>%
  spread(
    key = mean_sd,
    value = val
  ) %>%
  mutate(Statistics = paste0(round(Mean, 2), " (", round(SD, 2), ")")) %>%
  select(-Mean, -SD)

df %>%
  group_by(.data[[treatment]]) %>%
  summarise_at(
    .vars = var_named,
    .funs = list(
      "Mean" = ~weighted_mean(.x, obs_weights),
      "SD" = ~weighted_sd(.x, obs_weights)
    )
  ) %>%
  gather("Variable", "val", -.data[[treatment]]) %>%
  separate(Variable, c("Variable", "mean_sd"), "_(?!.*_)") %>%
  spread(key = mean_sd, value = val) %>%
  mutate(mean_sd = paste0(round(Mean, 2), " (", round(SD, 2), ")")) %>%
  select(-Mean, -SD) %>%
  spread(.data[[treatment]], mean_sd) %>%
  mutate(`P Value` = map_dbl(Variable, p_anova, df = df, treatment = treatment, weight_var = "obs_weights"))

```
