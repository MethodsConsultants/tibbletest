---
title: "Testing"
author: "Michael Battaglia"
date: "7/6/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tibbletest)
```

```{r}

example_dat %>%
  covariate_balance(
    treatment = "treat2",
    variables = c("age", "sugar_factor", "gender", "happiness", "happy"),
    nonparametric = "age",
    weights = "no_weight"
  ) %>%
  format_tbl()

```

```{r}

df <- example_dat
treatment <- "treat2"
var <- "happy"
weight_var <- "no_weight"

weighted_props <- df %>%
  drop_na(.data[[treatment]], .data[[var]]) %>%
  group_by(.data[[treatment]], .data[[var]]) %>%
  summarise_at(
    weight_var,
    sum
  ) %>%
  mutate(p = .data[[weight_var]] / sum(.data[[weight_var]])) %>%
  ungroup()

weighted_props_list <- split(
  weighted_props$p,
  weighted_props[[treatment]]
)

calculate_std_diff <- function(x) {
  
  prop_diff <- x[[1]] - x[[2]]

  var_1 <- x[[1]] * (1 - x[[1]])
  var_2 <- x[[2]] * (1 - x[[2]])
  
  pooled_sd <- sqrt(
    (var_1 + var_2) / 2
  )
  
  abs(100 * prop_diff / pooled_sd) %>%
    max()

}

combn(1:length(weighted_props_list), 2, simplify = FALSE) %>%
  map(
    ~ `[`(weighted_props_list, .x)
  ) %>%
  map_dbl(
    calculate_std_diff
  ) %>%
  max()

```






